<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Analysis | Phishing Detector</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=JetBrains+Mono:wght@400;500;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg: #0b0f19;
            --surface: #151b2b;
            --border: #2d3748;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --safe: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --primary-light: #818cf8;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
            background-image:
                linear-gradient(rgba(11, 15, 25, 0.95), rgba(11, 15, 25, 1)),
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%236366f1' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .container {
            background-color: var(--surface);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 650px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .glow-safe {
            box-shadow: 0 0 100px -20px rgba(34, 197, 94, 0.1), 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border-color: rgba(34, 197, 94, 0.3);
        }

        .glow-phishing {
            box-shadow: 0 0 100px -20px rgba(239, 68, 68, 0.1), 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .glow-warning {
            box-shadow: 0 0 100px -20px rgba(245, 158, 11, 0.1), 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border-color: rgba(245, 158, 11, 0.3);
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .nav-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-light);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-link:hover {
            color: #fff;
        }

        .url-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: #cbd5e1;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .copy-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.2s;
            padding: 0;
            display: flex;
        }

        .copy-btn:hover {
            color: #fff;
        }

        /* Verdict */
        .verdict-box {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2.5rem;
            flex-wrap: wrap;
        }

        .verdict-badge {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
        }

        .status-icon {
            width: 24px;
            height: 24px;
        }

        /* Gauge */
        .gauge-wrapper {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .gauge-svg {
            transform: rotate(-90deg);
        }

        .gauge-bg {
            fill: none;
            stroke: #1e293b;
            stroke-width: 8;
        }

        .gauge-value {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 339;
            stroke-dashoffset: 339;
            transition: stroke-dashoffset 1s ease-out;
        }

        .gauge-center-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .score-val {
            font-size: 1.5rem;
            font-weight: 800;
        }

        .score-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Grid */
        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            border-top: 1px solid var(--border);
            padding-top: 2rem;
        }

        .panel-heading {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .data-label {
            color: #64748b;
        }

        .data-val {
            color: #e2e8f0;
            font-family: 'JetBrains Mono', monospace;
        }

        .threat-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 0.375rem;
        }

        .threat-icon {
            margin-top: 2px;
            flex-shrink: 0;
        }

        .hidden {
            display: none !important;
        }

        /* Loader */
        .loader-wrapper {
            text-align: center;
            padding: 2rem;
        }

        .console-text {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        @media (max-width: 600px) {
            .grid-layout {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .verdict-box {
                flex-direction: column;
                gap: 1rem;
            }

            .header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .url-box {
                width: 100%;
                box-sizing: border-box;
            }
        }
    </style>
</head>

<body>
    <div class="container" id="mainContainer">

        <div id="loading" class="loader-wrapper">
            <div
                style="width: 40px; height: 40px; border: 3px solid #2d3748; border-top: 3px solid #6366f1; border-radius: 50%; animation: spin 1s infinite linear; margin: 0 auto 1.5rem;">
            </div>
            <div class="console-text">Analyzing endpoint metadata...</div>
        </div>

        <div id="result" class="hidden">
            <div class="header">
                <a href="/" class="nav-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    New Scan
                </a>

                <div class="url-box">
                    <span id="scannedUrl"></span>
                    <button class="copy-btn" onclick="copyUrl()" title="Copy URL">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="verdict-box">
                <div class="gauge-wrapper">
                    <svg class="gauge-svg" width="120" height="120">
                        <circle class="gauge-bg" cx="60" cy="60" r="54"></circle>
                        <circle class="gauge-value" id="riskCircle" cx="60" cy="60" r="54"></circle>
                    </svg>
                    <div class="gauge-center-text">
                        <div class="score-val" id="riskScore">0%</div>
                        <div class="score-label">Risk Score</div>
                    </div>
                </div>

                <div id="verdictBadge" class="verdict-badge">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div class="grid-layout">
                <div>
                    <div class="panel-heading">Detection Signals</div>
                    <div id="threatList">
                        <!-- Items -->
                    </div>
                </div>

                <div>
                    <div class="panel-heading">Intelligence Data</div>
                    <div class="data-row">
                        <span class="data-label">Domain Age</span>
                        <span class="data-val" id="domainAge"></span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Created On</span>
                        <span class="data-val" id="createdDate"></span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Registrar</span>
                        <span class="data-val" id="registrar"></span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">SSL Issuer</span>
                        <span class="data-val" id="sslIssuer"></span>
                    </div>
                </div>
            </div>
            <!-- Removed bottom button -->
        </div>
    </div>

    <script>
        const taskId = "{{ task_id }}";
        const loading = document.getElementById('loading');
        const resultDiv = document.getElementById('result');
        const mainContainer = document.getElementById('mainContainer');

        async function checkStatus() {
            try {
                const response = await fetch(`/api/result/${taskId}`);
                const data = await response.json();

                if (data.status === 'ready') {
                    showResult(data.result);
                } else if (data.status === 'error') {
                    loading.innerHTML = `<h3 style="color:#ef4444">Scan Failed</h3><p>${data.message}</p><a href='/' style='color:#fff'>Return</a>`;
                } else {
                    setTimeout(checkStatus, 1000);
                }
            } catch (err) {
                console.error(err);
                setTimeout(checkStatus, 2000);
            }
        }

        function showResult(result) {
            loading.classList.add('hidden');
            resultDiv.classList.remove('hidden');

            document.getElementById('scannedUrl').textContent = result.url;

            // Score Logic
            const score = Math.round(result.probability);
            document.getElementById('riskScore').textContent = `${score}%`;

            // Color Mapping
            let color = 'var(--safe)';
            let statusText = 'Legitimate';
            let statusIcon = '<svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" fill="rgba(34,197,94,0.1)"></path><path d="M9 12l2 2 4-4"></path></svg>';
            let glowClass = 'glow-safe';

            if (score > 60) {
                color = 'var(--danger)';
                statusText = 'Phishing Detected';
                glowClass = 'glow-phishing';
                statusIcon = '<svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';
            } else if (score >= 30) {
                color = 'var(--warning)';
                statusText = 'Suspicious';
                glowClass = 'glow-warning';
                statusIcon = '<svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
            }

            // Apply Styles
            mainContainer.classList.add(glowClass);
            const badge = document.getElementById('verdictBadge');
            badge.innerHTML = `${statusIcon}<span>${statusText}</span>`;
            badge.style.color = color;
            badge.style.borderColor = color;

            const circle = document.getElementById('riskCircle');
            circle.style.stroke = color;
            // 339 is circumference
            const offset = 339 - (339 * score / 100);
            setTimeout(() => { circle.style.strokeDashoffset = offset; }, 100);

            // Populate Data
            const d = result.details || {};
            document.getElementById('domainAge').textContent = d.domain_age_days > -1 ? `${d.domain_age_days} days` : 'N/A';
            document.getElementById('createdDate').textContent = d.creation_date || 'Unknown';
            document.getElementById('registrar').textContent = trimText(d.registrar || 'Unknown', 18);
            document.getElementById('sslIssuer').textContent = trimText(d.ssl_issuer || 'Unknown', 18);

            renderThreats(d, score > 60);
        }

        function renderThreats(d, isHighRisk) {
            const list = document.getElementById('threatList');
            const items = [];

            if (d.is_ssl_valid) items.push(mkThreat(true, "Valid SSL/TLS Certificate"));
            else items.push(mkThreat(false, "Invalid or Missing SSL"));

            if (d.domain_age_days > 180) items.push(mkThreat(true, "Established Domain Reputation"));
            else if (d.domain_age_days > 0) items.push(mkThreat(false, "Newly Registered Domain"));

            if (isHighRisk) items.push(mkThreat(false, "Suspicious URL Patterns"));
            else items.push(mkThreat(true, "Clean URL Structure"));

            list.innerHTML = items.join('');
        }

        function mkThreat(safe, text) {
            const color = safe ? 'var(--safe)' : 'var(--danger)';
            const icon = safe
                ? `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>`
                : `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
            return `<div class="threat-item"><div class="threat-icon">${icon}</div><div style="color:${safe ? '#cbd5e1' : '#fca5a5'}">${text}</div></div>`;
        }

        function trimText(text, len) {
            if (!text) return "";
            return text.length > len ? text.substring(0, len) + "..." : text;
        }

        function copyUrl() {
            const url = document.getElementById('scannedUrl').textContent;
            navigator.clipboard.writeText(url);
            alert("URL copied to clipboard!");
        }

        checkStatus();
    </script>
</body>

</html>